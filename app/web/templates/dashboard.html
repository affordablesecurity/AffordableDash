<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Affordable CRM</title>
    <link rel="stylesheet" href="/static/css/app.css"/>
  </head>

  <body>
    <header class="topbar">
      <div class="brand">Affordable CRM</div>

      <div class="right">
        <span class="user">{{ user.email }}</span>
        <a class="btn" href="/logout">Logout</a>
      </div>
    </header>

    <main class="container">
      <h1>Dashboard</h1>

      <div class="grid">
        <div class="card">
          <h2>Location</h2>

          <label for="locationSelect" style="display:block; margin-bottom: 6px;">
            Active location
          </label>

          <select id="locationSelect" style="width:100%; padding:10px;">
            <option value="">Loading...</option>
          </select>

          <p id="locationMeta" style="margin-top:10px; opacity:0.8;"></p>
        </div>

        <div class="card">
          <h2>Add Customer</h2>

          <form id="addCustomerForm">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div>
                <label>First name</label>
                <input id="firstName" type="text" required style="width:100%; padding:10px;" />
              </div>
              <div>
                <label>Last name</label>
                <input id="lastName" type="text" style="width:100%; padding:10px;" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
              <div>
                <label>Phone</label>
                <input id="phone" type="text" style="width:100%; padding:10px;" />
              </div>
              <div>
                <label>Email</label>
                <input id="email" type="email" style="width:100%; padding:10px;" />
              </div>
            </div>

            <div style="margin-top:10px;">
              <label>Notes</label>
              <textarea id="notes" rows="3" style="width:100%; padding:10px;"></textarea>
            </div>

            <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
              <button class="btn" type="submit">Create Customer</button>
              <span id="formStatus" style="opacity:0.85;"></span>
            </div>
          </form>
        </div>
      </div>

      <div class="card" style="margin-top: 18px;">
        <h2>Customers</h2>
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
          <button class="btn" id="refreshBtn" type="button">Refresh</button>
          <span id="listStatus" style="opacity:0.85;"></span>
        </div>

        <div style="overflow:auto;">
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Name</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Phone</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Email</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Notes</th>
              </tr>
            </thead>
            <tbody id="customersTbody">
              <tr><td colspan="4" style="padding:10px;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top: 18px;">
        <h2>Next build</h2>
        <ul>
          <li>Locations + User roles UI</li>
          <li>Customers module ✅ (starting now)</li>
          <li>Jobs + Scheduling</li>
          <li>Invoices + Stripe</li>
          <li>SMS/Email notifications</li>
        </ul>
      </div>
    </main>

    <script>
      // IMPORTANT: cookie auth requires credentials: "include"
      async function api(path, options = {}) {
        const res = await fetch(path, {
          ...options,
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            ...(options.headers || {})
          }
        });

        // Try JSON, fallback text
        const contentType = res.headers.get("content-type") || "";
        const body = contentType.includes("application/json") ? await res.json() : await res.text();

        if (!res.ok) {
          const msg = (body && body.detail) ? body.detail : (typeof body === "string" ? body : JSON.stringify(body));
          throw new Error(msg || `Request failed (${res.status})`);
        }
        return body;
      }

      let activeLocationId = null;
      let locationsCache = [];

      function setStatus(id, text, isError=false) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = text || "";
        el.style.color = isError ? "crimson" : "";
      }

      function renderCustomers(rows) {
        const tbody = document.getElementById("customersTbody");
        tbody.innerHTML = "";

        if (!rows || rows.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="padding:10px;">No customers yet.</td></tr>`;
          return;
        }

        for (const c of rows) {
          const name = `${c.first_name || ""} ${c.last_name || ""}`.trim();
          const phone = c.phone || "";
          const email = c.email || "";
          const notes = c.notes || "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(name)}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(phone)}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(email)}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(notes)}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      function escapeHtml(str) {
        return String(str || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function loadLocations() {
        setStatus("listStatus", "Loading locations...");
        const data = await api("/api/v1/locations/my", { method: "GET" });

        locationsCache = data.locations || [];
        const select = document.getElementById("locationSelect");
        select.innerHTML = "";

        if (locationsCache.length === 0) {
          select.innerHTML = `<option value="">No locations assigned</option>`;
          activeLocationId = null;
          setStatus("listStatus", "No locations assigned.", true);
          return;
        }

        for (const loc of locationsCache) {
          const opt = document.createElement("option");
          opt.value = String(loc.location_id);
          opt.textContent = `${loc.location_name} (ID: ${loc.location_id})`;
          select.appendChild(opt);
        }

        // default location: server provided OR first
        activeLocationId = data.default_location_id || locationsCache[0].location_id;
        select.value = String(activeLocationId);
        updateLocationMeta();
        setStatus("listStatus", "");
      }

      function updateLocationMeta() {
        const meta = document.getElementById("locationMeta");
        const loc = locationsCache.find(x => String(x.location_id) === String(activeLocationId));
        if (!loc) {
          meta.textContent = "";
          return;
        }
        meta.textContent = `Org: ${loc.organization_id} • Role: ${loc.role}`;
      }

      async function refreshCustomers() {
        if (!activeLocationId) {
          renderCustomers([]);
          setStatus("listStatus", "Pick a location first.", true);
          return;
        }
        setStatus("listStatus", "Loading customers...");
        const rows = await api(`/api/v1/customers/?location_id=${encodeURIComponent(activeLocationId)}`, { method: "GET" });
        renderCustomers(rows);
        setStatus("listStatus", "");
      }

      async function createCustomerFromForm(e) {
        e.preventDefault();
        setStatus("formStatus", "");

        if (!activeLocationId) {
          setStatus("formStatus", "Pick a location first.", true);
          return;
        }

        const payload = {
          location_id: Number(activeLocationId),
          first_name: document.getElementById("firstName").value.trim(),
          last_name: document.getElementById("lastName").value.trim(),
          phone: document.getElementById("phone").value.trim() || null,
          email: document.getElementById("email").value.trim() || null,
          notes: document.getElementById("notes").value.trim() || null,
        };

        try {
          setStatus("formStatus", "Creating...");
          await api("/api/v1/customers/", {
            method: "POST",
            body: JSON.stringify(payload),
          });

          setStatus("formStatus", "Customer created ✅");
          document.getElementById("addCustomerForm").reset();
          await refreshCustomers();
        } catch (err) {
          setStatus("formStatus", err.message || "Failed to create customer", true);
        }
      }

      function wireEvents() {
        document.getElementById("addCustomerForm").addEventListener("submit", createCustomerFromForm);
        document.getElementById("refreshBtn").addEventListener("click", refreshCustomers);

        document.getElementById("locationSelect").addEventListener("change", async (e) => {
          activeLocationId = e.target.value ? Number(e.target.value) : null;
          updateLocationMeta();
          await refreshCustomers();
        });
      }

      (async function init() {
        try {
          wireEvents();
          await loadLocations();
          await refreshCustomers();
        } catch (err) {
          setStatus("listStatus", err.message || "Failed to load dashboard data", true);
          console.error(err);
        }
      })();
    </script>
  </body>
</html>
